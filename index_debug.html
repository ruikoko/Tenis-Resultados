
<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DEBUG • Resultados (detetor de nomes partidos)</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
  h1 { margin:0 0 6px; }
  .warn { padding:10px 12px; background:#fff3cd; border:1px solid #ffe69c; border-radius:8px; }
  .ok { padding:10px 12px; background:#e8f5e9; border:1px solid #c8e6c9; border-radius:8px; }
  table { width:100%; border-collapse: collapse; margin-top: 16px; }
  th,td { border-bottom:1px solid #eee; padding:8px; font-size:14px; text-align:left; vertical-align:top; }
  th { background:#fafafa; position:sticky; top:0; }
  .sus { color:#b00020; font-weight:600; }
  .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; margin-right:6px; font-size:12px; }
</style>
</head>
<body>
  <h1>DEBUG • Resultados (detetor de nomes partidos)</h1>
  <p>Este ficheiro serve apenas para confirmar que o CSV carregado é o mais recente e que a normalização funciona no browser.</p>
  <p><span class="pill">CSV: resultados_2025w36.csv</span> <span id="stamp" class="pill"></span></p>

  <div id="status" class="warn">A carregar…</div>

  <table id="tbl">
    <thead>
      <tr>
        <th>Campo</th><th>Valor original</th><th>Valor após normalização</th><th>Problema</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>

const PARTICLES = ["DE","DEL","DELA","DA","DOS","DAS","DO","DI","DU","LA","LE","LO","VAN","VON","DER","DEN"];
const NAME_OVERRIDES = {
  "Daniel DU TRA DA SILVA": "Daniel DUTRA DA SILVA",
  "Felipe DE DI OS": "Felipe DE DIOS",
  "Joao Vitor SCRAMIN DO LA GO": "Joao Vitor SCRAMIN DO LAGO",
  "Juan Ignacio CENTURION DE L VALLE": "Juan Ignacio CENTURION DEL VALLE",
  "Nicolas GARCIA LO NGO": "Nicolas GARCIA LONGO",
  "Wilson LE ITE": "Wilson LEITE",
  "Mateo DE L PINO": "Mateo DEL PINO"
};

function normalizeName(name) {
  if (!name) return name;
  if (NAME_OVERRIDES[name]) return NAME_OVERRIDES[name];
  const suffixes = [...name.matchAll(/(\(.*?\)|\[[^\]]*\])/g)].map(m => m[0]);
  let base = name.replace(/(\(.*?\)|\[[^\]]*\])/g, "").trim();
  base = base.replace(/\s+/g, " ");
  // Fix single-letter token splits
  base = base.replace(/\bDU\s+TRA\b/gi, "DUTRA")
             .replace(/\bDE\s+DI\s+OS\b/gi, "DE DIOS")
             .replace(/\bDE\s+L\s+PINO\b/gi, "DEL PINO")
             .replace(/\bDE\s+L\s+VALLE\b/gi, "DEL VALLE")
             .replace(/\bDO\s+LA\s+GO\b/gi, "DO LAGO")
             .replace(/\bLO\s+NGO\b/gi, "LONGO")
             .replace(/\bLE\s+ITE\b/gi, "LEITE");
  // Insert space before uppercase surname glued to given name
  base = base.replace(/([a-záéíóúñü]+)([A-ZÁÉÍÓÚÑÜ]{2,})/g, "$1 $2");
  // Ensure particles glued are spaced
  for (const part of [...PARTICLES].sort((a,b)=>b.length-a.length)) {
    const re = new RegExp(`\\b${part}([A-ZÁÉÍÓÚÑÜ]+)\\b`, "g");
    base = base.replace(re, `${part} $1`);
  }
  base = base.replace(/\s+/g, " ").trim();
  if (suffixes.length) base += " " + suffixes.join(" ");
  return base;
}

function hasOneLetterToken(name) {
  return !!(name && name.split(/\s+/).some(t => /^[A-ZÁÉÍÓÚÑÜ]$/.test(t)));
}
function hasSplitParticles(name) {
  return /\bDE\s+L\b|\bLO\s+NGO\b|\bLE\s+ITE\b|\bDU\s+TRA\b|\bDE\s+DI\s+OS\b|\bDO\s+LA\s+GO\b/i.test(name || "");
}


const CSV_URL = "resultados_2025w36.csv";
function bust(u) { return u + "?v=" + Date.now(); }

function rowCheck(field, original) {
  const normalized = normalizeName(original);
  let prob = "";
  if (hasOneLetterToken(original) || hasSplitParticles(original)) prob = "Original tem tokens partidos";
  return { field, original, normalized, prob };
}

Papa.parse(bust(CSV_URL), {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: (res) => {
    const rows = res.data;
    document.getElementById('stamp').textContent = "Linhas: " + rows.length + " • " + new Date().toLocaleString();
    const checks = [];
    for (const r of rows) {
      for (const field of ["jogador_a","jogador_b","vencedor"]) {
        const orig = r[field];
        if (!orig) continue;
        const c = rowCheck(field, orig);
        // Só mostrar linhas que têm mesmo problema OU diferença após normalização
        if (c.prob || c.original !== c.normalized) checks.push(c);
      }
    }
    const tbody = document.querySelector('#tbl tbody');
    if (checks.length === 0) {
      document.getElementById('status').className = "ok";
      document.getElementById('status').textContent = "Sem problemas detetados — nomes já estão corretos no CSV e/ou normalizados no browser.";
    } else {
      document.getElementById('status').className = "warn";
      document.getElementById('status').textContent = "Foram detetadas " + checks.length + " ocorrências com nomes partidos. A normalização de runtime resolve.";
    }
    tbody.innerHTML = checks.map(c => `
      <tr>
        <td>\${c.field}</td>
        <td class="sus">\${c.original}</td>
        <td><strong>\${c.normalized}</strong></td>
        <td>\${c.prob || ""}</td>
      </tr>
    `).join("");
  },
  error: (err) => {
    document.getElementById('status').textContent = "Erro a carregar CSV: " + err;
  }
});
</script>
</body>
</html>
